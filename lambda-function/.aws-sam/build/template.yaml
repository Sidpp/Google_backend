AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Deploys a Lambda function triggered by two SQS queues to process Google
  Sheet data using OpenAI for AI predictions.

  '
Parameters:
  BulkImportQueueArn:
    Type: String
    Description: The ARN of the SQS queue for bulk data imports.
  UpdateQueueArn:
    Type: String
    Description: The ARN of the SQS queue for on-edit updates.
  MongoUri:
    Type: String
    NoEcho: true
    Description: The connection string for MongoDB.
  DbName:
    Type: String
    Description: The name of the MongoDB database.
    Default: GoogleSheetData
  ProcessedDataCollection:
    Type: String
    Description: The name of the collection to store processed data.
    Default: processed_rows
  OpenAiApiKey:
    Type: String
    NoEcho: true
    Description: The API key for OpenAI.
  OpenAiModel:
    Type: String
    Description: The model to use for OpenAI predictions.
    Default: o4-mini
Resources:
  DataProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GoogleSheetDataProcessor
      Description: Processes Google Sheet data from SQS, enriches it with OpenAI,
        and stores it.
      CodeUri: DataProcessorFunction
      Handler: handler.handler
      Runtime: nodejs20.x
      MemorySize: 256
      Timeout: 90
      Environment:
        Variables:
          MONGO_URI:
            Ref: MongoUri
          DB_NAME:
            Ref: DbName
          PROCESSED_DATA_COLLECTION:
            Ref: ProcessedDataCollection
          OPENAI_API_KEY:
            Ref: OpenAiApiKey
          OPENAI_MODEL:
            Ref: OpenAiModel
      Events:
        SQSEventBulk:
          Type: SQS
          Properties:
            Queue:
              Ref: BulkImportQueueArn
            BatchSize: 10
            Enabled: true
        SQSEventUpdate:
          Type: SQS
          Properties:
            Queue:
              Ref: UpdateQueueArn
            BatchSize: 5
            Enabled: true
    Metadata:
      SamResourceId: DataProcessorFunction
Outputs:
  FunctionName:
    Description: The name of the created Lambda function
    Value:
      Ref: DataProcessorFunction
